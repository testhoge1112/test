<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Memo & Pomodoro</title>
    <style>
        * { box-sizing: border-box; }
        :root {
            --bg-color: #eef0f4; --paper-color: #ffffff;
            --btn-border: #333; --active-color: #ffcc00; --danger-color: #ff3b30;
        }
        body {
            background-color: var(--bg-color); margin: 0; padding: 30px 20px;
            font-family: sans-serif; display: flex; justify-content: center; min-height: 100vh;
        }
        
        .app-container {
            width: 100%; max-width: 900px;
            background-color: var(--paper-color);
            border-radius: 12px; padding: 30px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; height: 85vh;
        }
        
        .header-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;
        }
        .header-nav button {
            background: #f0f0f5; border: none; font-size: 20px; color: #555;
            cursor: pointer; padding: 10px 20px; border-radius: 8px; font-weight: bold;
            transition: 0.2s;
        }
        .header-nav button:hover:not(:disabled) { background: #e0e0e0; }
        .header-nav button:disabled { color: #ccc; background: transparent; cursor: default; }
        .header-nav h1 { margin: 0; font-size: 24px; color: #333; letter-spacing: 2px; }

        .main-area { 
            display: flex; gap: 20px; flex-grow: 1; overflow: hidden; 
            justify-content: space-between;
        }
        
        /* タイマーエリア */
        .timer-side {
            width: 130px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            border: 1px solid #eee;
        }
        /* ▼▼▼ タイマーの数字をクリックできるように ▼▼▼ */
        .timer-display {
            font-size: 32px; font-family: monospace; font-weight: bold; color: #333;
            letter-spacing: 1px; cursor: pointer; transition: 0.2s;
            margin-top: 10px;
        }
        .timer-display:hover { color: #007AFF; transform: scale(1.05); }
        .timer-hint { font-size: 11px; color: #888; margin-bottom: 5px; }

        .timer-controls { display: flex; gap: 15px; margin-top: 10px; }
        .timer-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid #ccc;
            background: white; font-size: 18px; display: flex; justify-content: center; 
            align-items: center; cursor: pointer; color: #555; transition: 0.1s;
        }
        .timer-btn:active { background: #eee; transform: scale(0.95); }

        .memo-box { 
            flex: 1; border: 2px solid #ccc; border-radius: 8px; padding: 15px; 
            display: flex; flex-direction: column; background: #fafafa;
        }
        textarea { 
            width: 100%; height: 100%; border: none; resize: none; 
            font-size: 16px; outline: none; font-family: inherit; background: transparent;
            line-height: 1.6;
        }
        
        .button-area { 
            width: 90px; display: flex; flex-direction: column; align-items: center; 
            gap: 15px; overflow-y: auto; padding-right: 5px;
        }
        
        .circle-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--btn-border);
            background: white; display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: bold; text-align: center; cursor: pointer;
            transition: 0.2s; position: relative; flex-shrink: 0; word-break: break-all;
        }
        .circle-btn.active { background-color: var(--active-color); box-shadow: 0 0 10px rgba(255, 204, 0, 0.5); }
        
        .editing .circle-btn { border-style: dashed; animation: shake 0.3s infinite alternate; }
        @keyframes shake { from { transform: rotate(-2deg); } to { transform: rotate(2deg); } }
        
        .del-badge {
            display: none; position: absolute; top: -5px; right: -5px; width: 24px; height: 24px;
            background: var(--danger-color); color: white; border-radius: 50%; font-size: 14px;
            line-height: 24px; text-align: center; font-weight: bold;
        }
        .editing .del-badge { display: block; }
        
        .add-btn {
            display: none; width: 50px; height: 50px; border-radius: 50%; border: 2px dashed #aaa;
            color: #aaa; font-size: 28px; background: none; cursor: pointer; justify-content: center; align-items: center;
        }
        .editing .add-btn { display: flex; }
        
        .controls { 
            margin-top: 20px; display: flex; justify-content: space-between; align-items: center; 
            padding-top: 15px;
        }
        button.text-btn { background: none; border: none; color: #007AFF; font-size: 16px; cursor: pointer; font-weight: bold; }
        button.save-btn { background-color: #333; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.save-btn:hover { background-color: #555; }
        button.save-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="app-container" id="app">
        <div class="header-nav">
            <button id="prev-btn">◀ 過去</button>
            <h1 id="date-label">----/--/--</h1>
            <button id="next-btn" disabled>未来 ▶</button>
        </div>

        <div class="main-area">
            <div class="timer-side" id="timer-left">
                <span class="timer-hint">集中 (クリックで設定)</span>
                <div class="timer-display" id="display-left" onclick="editTimer('left')">25:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" onclick="startTimer('left')">▶</button>
                    <button class="timer-btn" onclick="resetTimer('left')">↻</button>
                </div>
            </div>

            <div class="memo-box">
                <textarea id="memo" placeholder="今日のメモや作業内容を書き込みましょう..."></textarea>
            </div>

            <div class="button-area" id="btn-list"></div>

            <div class="timer-side" id="timer-right">
                <span class="timer-hint">休憩 (クリックで設定)</span>
                <div class="timer-display" id="display-right" onclick="editTimer('right')">05:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" onclick="startTimer('right')">▶</button>
                    <button class="timer-btn" onclick="resetTimer('right')">↻</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="text-btn" id="edit-mode">⚙️ ボタン編集</button>
            <span id="status" style="font-size:14px; color:#666; font-weight:bold;"></span>
            <button class="save-btn" id="save">記録を保存</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ↓↓↓ 新しくデプロイしたGASのURLを貼る ↓↓↓
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzG3v5dARg29VMT_J0eFSkq_xCfZDiS4MPM72Klc_6wO7-Ej8r7MSJ-kG7OdLKjk6Ramg/exec";
        // ==========================================

        const app = document.getElementById('app');
        const btnList = document.getElementById('btn-list');
        const memoArea = document.getElementById('memo');
        const dateLabel = document.getElementById('date-label');
        const statusLabel = document.getElementById('status');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // ▼▼▼ カウントダウンタイマーのプログラム ▼▼▼
        // 保存されている設定時間があれば読み込む（なければ左25分、右5分）
        let savedTimerSettings = JSON.parse(localStorage.getItem('memo_timer_settings')) || { left: 25, right: 5 };

        const timers = {
            left: { defaultTime: savedTimerSettings.left * 60, time: savedTimerSettings.left * 60, interval: null, isRunning: false },
            right: { defaultTime: savedTimerSettings.right * 60, time: savedTimerSettings.right * 60, interval: null, isRunning: false }
        };

        function updateTimerDisplay(side) {
            const m = String(Math.floor(timers[side].time / 60)).padStart(2, '0');
            const s = String(timers[side].time % 60).padStart(2, '0');
            document.getElementById(`display-${side}`).textContent = `${m}:${s}`;
        }

        // 時間をクリックして変更する機能
        function editTimer(side) {
            if (timers[side].isRunning) return; // 動いている最中は変更不可
            const currentMins = Math.floor(timers[side].defaultTime / 60);
            const input = prompt("タイマーの時間を設定してください（分）\n例: 25", currentMins);
            
            if (input !== null && !isNaN(input) && input > 0) {
                const newMins = Math.floor(input);
                timers[side].defaultTime = newMins * 60;
                timers[side].time = timers[side].defaultTime;
                
                // 次回開いた時にも設定を覚えておくように保存
                savedTimerSettings[side] = newMins;
                localStorage.setItem('memo_timer_settings', JSON.stringify(savedTimerSettings));
                
                updateTimerDisplay(side);
            }
        }

        function startTimer(side) {
            const btn = document.querySelector(`#timer-${side} .timer-btn:first-child`);
            if (timers[side].isRunning) {
                // 一時停止
                clearInterval(timers[side].interval);
                btn.textContent = '▶';
            } else {
                // 0秒ならリセットしてからスタート
                if (timers[side].time <= 0) {
                    timers[side].time = timers[side].defaultTime;
                }
                
                // カウントダウン開始
                timers[side].interval = setInterval(() => {
                    if (timers[side].time > 0) {
                        timers[side].time--;
                        updateTimerDisplay(side);
                    } else {
                        // 0になった時（アラーム）
                        clearInterval(timers[side].interval);
                        timers[side].isRunning = false;
                        btn.textContent = '▶';
                        playPopSound(); 
                        alert((side === 'left' ? "集中（左）" : "休憩（右）") + "の時間が終了しました！");
                    }
                }, 1000);
                btn.textContent = '⏸';
            }
            timers[side].isRunning = !timers[side].isRunning;
            playPopSound();
        }

        function resetTimer(side) {
            clearInterval(timers[side].interval);
            timers[side].time = timers[side].defaultTime;
            timers[side].isRunning = false;
            document.querySelector(`#timer-${side} .timer-btn:first-child`).textContent = '▶';
            updateTimerDisplay(side);
            playPopSound();
        }

        // 起動時にタイマーの表示を合わせる
        updateTimerDisplay('left');
        updateTimerDisplay('right');
        // ▲▲▲ カウントダウンタイマーここまで ▲▲▲

        const defaultButtons = [
            { id: 1, text: "朝", on: false },
            { id: 2, text: "昼", on: false },
            { id: 3, text: "夜", on: false }
        ];

        let isEditing = false;
        let buttons = [];
        let currentDateObj = new Date(); 
        let serverData = {}; 

        function formatDate(d) {
            return d.toLocaleDateString("ja-JP", { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        async function loadDataFromServer() {
            statusLabel.textContent = "データ読込中...";
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                data.forEach(row => { serverData[row.date] = { memo: row.memo, buttons: row.buttons }; });
                statusLabel.textContent = "";
            } catch (error) {
                console.log("読込エラー:", error);
                statusLabel.textContent = "";
            }
            changeDate(0); 
        }

        function changeDate(daysToAdd) {
            currentDateObj.setDate(currentDateObj.getDate() + daysToAdd);
            const dateStr = formatDate(currentDateObj);
            const todayStr = formatDate(new Date());
            
            dateLabel.textContent = dateStr;
            nextBtn.disabled = (dateStr === todayStr);

            if (serverData[dateStr]) {
                memoArea.value = serverData[dateStr].memo || "";
                try {
                    buttons = JSON.parse(serverData[dateStr].buttons);
                    if(!Array.isArray(buttons)) throw new Error("Not Array");
                } catch(e) {
                    buttons = JSON.parse(JSON.stringify(defaultButtons));
                }
            } else {
                if (dateStr === todayStr) {
                    memoArea.value = localStorage.getItem('memo_draft') || "";
                    try {
                        buttons = JSON.parse(localStorage.getItem('memo_buttons'));
                        if(!Array.isArray(buttons)) throw new Error("Not Array");
                    } catch(e) {
                        buttons = JSON.parse(JSON.stringify(defaultButtons));
                    }
                } else {
                    memoArea.value = "";
                    buttons = JSON.parse(JSON.stringify(defaultButtons));
                }
            }
            render();
        }

        prevBtn.onclick = () => changeDate(-1);
        nextBtn.onclick = () => changeDate(1);

        function playPopSound() {
            const audio = new Audio('se.mp3'); 
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("再生エラー:", e));
        }

        function render() {
            btnList.innerHTML = ""; 
            buttons.forEach((btn, idx) => {
                const div = document.createElement('div');
                div.className = `circle-btn ${btn.on ? 'active' : ''}`;
                div.innerHTML = `<span>${btn.text}</span>`;
                
                const del = document.createElement('div');
                del.className = "del-badge";
                del.textContent = "×";
                del.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("削除しますか？")) {
                        buttons.splice(idx, 1);
                        saveState();
                        render();
                    }
                };
                div.appendChild(del);

                div.onclick = () => {
                    playPopSound();
                    if (isEditing) {
                        const newText = prompt("ボタンの名前を変更", btn.text);
                        if(newText) {
                            btn.text = newText;
                            saveState();
                            render();
                        }
                    } else {
                        btn.on = !btn.on;
                        saveState();
                        render();
                    }
                };
                btnList.appendChild(div);
            });

            if (isEditing) {
                const addBtn = document.createElement('div');
                addBtn.className = "add-btn";
                addBtn.textContent = "+";
                addBtn.onclick = () => {
                    const name = prompt("新しいボタンの名前");
                    if(name) {
                        buttons.push({ id: Date.now(), text: name, on: false });
                        saveState();
                        render();
                    }
                };
                btnList.appendChild(addBtn);
            }
        }

        function saveState() {
            if (dateLabel.textContent === formatDate(new Date())) {
                localStorage.setItem('memo_buttons', JSON.stringify(buttons));
            }
        }

        document.getElementById('edit-mode').onclick = function() {
            isEditing = !isEditing;
            app.classList.toggle('editing', isEditing);
            this.textContent = isEditing ? "完了" : "⚙️ ボタン編集";
            render();
        };

        document.getElementById('save').onclick = function() {
            statusLabel.textContent = "送信中...";
            const currentDisplayedDate = dateLabel.textContent;
            
            const payload = {
                date: currentDisplayedDate,
                memo: memoArea.value,
                buttons: buttons
            };

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(() => {
                statusLabel.textContent = "✅ 完了！";
                setTimeout(() => statusLabel.textContent = "", 2000);
                serverData[currentDisplayedDate] = { 
                    memo: memoArea.value, 
                    buttons: JSON.stringify(buttons) 
                };
            })
            .catch(err => {
                statusLabel.textContent = "❌ エラー";
                alert("送信失敗");
            });
        };

        memoArea.addEventListener('input', function() {
            if (dateLabel.textContent === formatDate(new Date())) {
                localStorage.setItem('memo_draft', memoArea.value);
            }
        });

        const todayStr = formatDate(new Date());
        const lastDate = localStorage.getItem('memo_last_date');
        if (lastDate && lastDate !== todayStr) {
            let localBtns = JSON.parse(localStorage.getItem('memo_buttons')) || defaultButtons;
            localBtns.forEach(btn => btn.on = false);
            localStorage.setItem('memo_buttons', JSON.stringify(localBtns));
        }
        localStorage.setItem('memo_last_date', todayStr);

        loadDataFromServer();

    </script>
</body>
</html>
