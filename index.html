<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Memo</title>
    <style>
        * { box-sizing: border-box; }
        :root {
            --bg-color: #f0f0f5; --paper-color: #ffffff;
            --btn-border: #333; --active-color: #ffcc00; --danger-color: #ff3b30;
        }
        body {
            background-color: var(--bg-color); margin: 0; padding: 20px;
            font-family: sans-serif; display: flex; justify-content: center; min-height: 100vh;
        }
        .app-container {
            width: 100%; max-width: 390px; background-color: var(--paper-color);
            border-radius: 20px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; height: 80vh;
        }
        
        /* ▼▼▼ 追加：日付ナビゲーションのスタイル ▼▼▼ */
        .header-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .header-nav button {
            background: none; border: none; font-size: 20px; color: #007AFF;
            cursor: pointer; padding: 5px 15px; font-weight: bold;
        }
        .header-nav button:disabled { color: #ccc; cursor: default; }
        .header-nav h1 { margin: 0; font-size: 18px; color: #555; }
        /* ▲▲▲ 追加ここまで ▲▲▲ */

        .main-area { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
        .memo-box { flex: 1; border: 2px solid #555; border-radius: 5px; padding: 10px; display: flex; flex-direction: column; }
        textarea { width: 100%; height: 100%; border: none; resize: none; font-size: 16px; outline: none; font-family: inherit; }
        .button-area { width: 70px; display: flex; flex-direction: column; align-items: center; gap: 15px; overflow-y: auto; }
        
        .circle-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--btn-border);
            background: white; display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; text-align: center; cursor: pointer;
            transition: 0.2s; position: relative; flex-shrink: 0; word-break: break-all;
        }
        .circle-btn.active { background-color: var(--active-color); }
        
        .editing .circle-btn { border-style: dashed; animation: shake 0.3s infinite alternate; }
        @keyframes shake { from { transform: rotate(-2deg); } to { transform: rotate(2deg); } }
        
        .del-badge {
            display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            background: var(--danger-color); color: white; border-radius: 50%; font-size: 14px;
            line-height: 20px; text-align: center;
        }
        .editing .del-badge { display: block; }
        
        .add-btn {
            display: none; width: 50px; height: 50px; border-radius: 50%; border: 2px dashed #aaa;
            color: #aaa; font-size: 24px; background: none; cursor: pointer; justify-content: center; align-items: center;
        }
        .editing .add-btn { display: flex; }
        
        .controls { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #ddd; padding-top: 15px; }
        button.text-btn { background: none; border: none; color: #007AFF; font-size: 14px; cursor: pointer; }
        button.save-btn { background-color: #333; color: white; border: none; padding: 10px 30px; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button.save-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="app-container" id="app">
        <div class="header-nav">
            <button id="prev-btn">◀</button>
            <h1 id="date-label">----/--/--</h1>
            <button id="next-btn" disabled>▶</button>
        </div>

        <div class="main-area">
            <div class="memo-box">
                <textarea id="memo" placeholder="メモ"></textarea>
            </div>
            <div class="button-area" id="btn-list"></div>
        </div>

        <div class="controls">
            <button class="text-btn" id="edit-mode">ボタン編集</button>
            <span id="status" style="font-size:12px; color:#888;"></span>
            <button class="save-btn" id="save">記録</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ↓↓↓ 新しくデプロイしたGASのURLを貼る ↓↓↓
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzG3v5dARg29VMT_J0eFSkq_xCfZDiS4MPM72Klc_6wO7-Ej8r7MSJ-kG7OdLKjk6Ramg/exec";
        // ==========================================

        const app = document.getElementById('app');
        const btnList = document.getElementById('btn-list');
        const memoArea = document.getElementById('memo');
        const dateLabel = document.getElementById('date-label');
        const statusLabel = document.getElementById('status');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // デフォルトのボタン構成
        const defaultButtons = [
            { id: 1, text: "朝", on: false },
            { id: 2, text: "昼", on: false },
            { id: 3, text: "夜", on: false }
        ];

        let isEditing = false;
        let buttons = [];
        let currentDateObj = new Date(); // 現在画面に表示している日付
        let serverData = {}; // サーバーから読み込んだ全データ

        // 日付を「YYYY/MM/DD」形式にする関数
        function formatDate(d) {
            return d.toLocaleDateString("ja-JP", { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        // ▼▼▼ 追加：サーバーからデータを読み込む ▼▼▼
        async function loadDataFromServer() {
            statusLabel.textContent = "読込中...";
            try {
                // GETリクエストでスプレッドシートのデータを取得
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                // データを日付ごとに整理して保存
                data.forEach(row => {
                    serverData[row.date] = { memo: row.memo, buttons: row.buttons };
                });
                
                statusLabel.textContent = "";
                changeDate(0); // 今日のデータを表示
            } catch (error) {
                statusLabel.textContent = "読込エラー";
                console.error(error);
                changeDate(0); // エラーでもとりあえず今日の画面は出す
            }
        }

        // ▼▼▼ 追加：日付を切り替える機能 ▼▼▼
        function changeDate(daysToAdd) {
            // 日付を足し引きする
            currentDateObj.setDate(currentDateObj.getDate() + daysToAdd);
            const dateStr = formatDate(currentDateObj);
            const todayStr = formatDate(new Date());
            
            dateLabel.textContent = dateStr;
            
            // 未来には行けないようにする
            nextBtn.disabled = (dateStr === todayStr);

            // 表示するデータを用意する
            if (serverData[dateStr]) {
                // サーバーに過去のデータがあれば表示
                memoArea.value = serverData[dateStr].memo;
                buttons = JSON.parse(serverData[dateStr].buttons);
            } else {
                // データがない場合（今日、または書いていない過去）
                if (dateStr === todayStr) {
                    // 今日の場合は書きかけ保存データを復元
                    memoArea.value = localStorage.getItem('memo_draft') || "";
                    buttons = JSON.parse(localStorage.getItem('memo_buttons')) || JSON.parse(JSON.stringify(defaultButtons));
                } else {
                    // 過去の空の日はリセット状態
                    memoArea.value = "";
                    buttons = JSON.parse(JSON.stringify(defaultButtons));
                }
            }
            render();
        }

        // ◀ ▶ ボタンのイベント
        prevBtn.onclick = () => changeDate(-1);
        nextBtn.onclick = () => changeDate(1);

        function playPopSound() {
            const audio = new Audio('se.mp3'); 
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("再生エラー:", e));
        }

        function render() {
            btnList.innerHTML = ""; 
            buttons.forEach((btn, idx) => {
                const div = document.createElement('div');
                div.className = `circle-btn ${btn.on ? 'active' : ''}`;
                div.innerHTML = `<span>${btn.text}</span>`;
                
                const del = document.createElement('div');
                del.className = "del-badge";
                del.textContent = "×";
                del.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("削除しますか？")) {
                        buttons.splice(idx, 1);
                        saveState();
                        render();
                    }
                };
                div.appendChild(del);

                div.onclick = () => {
                    playPopSound();
                    if (isEditing) {
                        const newText = prompt("ボタンの名前を変更", btn.text);
                        if(newText) {
                            btn.text = newText;
                            saveState();
                            render();
                        }
                    } else {
                        btn.on = !btn.on;
                        saveState();
                        render();
                    }
                };
                btnList.appendChild(div);
            });

            if (isEditing) {
                const addBtn = document.createElement('div');
                addBtn.className = "add-btn";
                addBtn.textContent = "+";
                addBtn.onclick = () => {
                    const name = prompt("新しいボタンの名前");
                    if(name) {
                        buttons.push({ id: Date.now(), text: name, on: false });
                        saveState();
                        render();
                    }
                };
                btnList.appendChild(addBtn);
            }
        }

        // 今見ているのが「今日」ならスマホに状態を保存する
        function saveState() {
            if (dateLabel.textContent === formatDate(new Date())) {
                localStorage.setItem('memo_buttons', JSON.stringify(buttons));
            }
        }

        document.getElementById('edit-mode').onclick = function() {
            isEditing = !isEditing;
            app.classList.toggle('editing', isEditing);
            this.textContent = isEditing ? "完了" : "ボタン編集";
            render();
        };

        // ▼▼▼ 変更：表示中の日付（過去も含む）を指定して送信 ▼▼▼
        document.getElementById('save').onclick = function() {
            statusLabel.textContent = "送信中...";
            const currentDisplayedDate = dateLabel.textContent;
            
            const payload = {
                date: currentDisplayedDate, // 表示中の日付を送る
                memo: memoArea.value,
                buttons: buttons
            };

            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            })
            .then(() => {
                statusLabel.textContent = "完了！";
                setTimeout(() => statusLabel.textContent = "", 2000);
                
                // 送信した内容を一時データにも反映（過去の編集用）
                serverData[currentDisplayedDate] = { 
                    memo: memoArea.value, 
                    buttons: JSON.stringify(buttons) 
                };
            })
            .catch(err => {
                statusLabel.textContent = "エラー";
                alert("送信失敗");
            });
        };

        // スマホへの自動書きかけ保存（今日を見ている時だけ）
        memoArea.addEventListener('input', function() {
            if (dateLabel.textContent === formatDate(new Date())) {
                localStorage.setItem('memo_draft', memoArea.value);
            }
        });

        // 日付またぎリセット処理
        const todayStr = formatDate(new Date());
        const lastDate = localStorage.getItem('memo_last_date');
        if (lastDate && lastDate !== todayStr) {
            // 今日のボタンを一旦全部OFFにする（過去には影響しない）
            let localBtns = JSON.parse(localStorage.getItem('memo_buttons')) || defaultButtons;
            localBtns.forEach(btn => btn.on = false);
            localStorage.setItem('memo_buttons', JSON.stringify(localBtns));
        }
        localStorage.setItem('memo_last_date', todayStr);

        // 起動時にサーバーからデータを読み込む
        loadDataFromServer();

    </script>
</body>
</html>
